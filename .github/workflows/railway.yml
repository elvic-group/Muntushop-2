name: Deploy to Railway

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest
        
      - name: Verify Railway CLI installation
        run: railway --version
        
      - name: Link Railway project
        run: |
          if [ -n "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            echo "Linking to Railway project: ${{ secrets.RAILWAY_PROJECT_ID }}"
            echo "${{ secrets.RAILWAY_PROJECT_ID }}" | railway link --non-interactive
          else
            echo "No RAILWAY_PROJECT_ID provided. Attempting to use existing link..."
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true
        
      - name: Deploy to Railway
        run: railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          
      - name: Check deployment status
        if: failure()
        run: |
          echo "::error::Deployment failed!"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Verify RAILWAY_TOKEN secret is set in GitHub repository settings (Settings > Secrets and variables > Actions)"
          echo "2. Ensure the Railway project is linked. Run 'railway link' locally and commit the .railway directory, OR"
          echo "3. Set RAILWAY_PROJECT_ID and RAILWAY_SERVICE_ID as secrets if not using .railway directory"
          echo "4. Check Railway dashboard for detailed deployment logs"
          echo ""
          echo "To get your Railway token:"
          echo "  railway login"
          echo "  railway tokens create"
          exit 1

